# 开发日志 - 智能批改助手

---

## 2026-01-14 评分细则 JSON 格式改造

### 19:30 - 后端类型定义

**新增文件**: `/ai-grading-backend/src/lib/rubric-types.ts`

定义了标准的 RubricJSON Schema：
```typescript
interface RubricJSON {
  version: '1.0';
  questionId: string;
  title: string;
  totalScore: number;
  scoringStrategy: ScoringStrategy;
  answerPoints: AnswerPoint[];
  gradingNotes: string[];
}
```

包含验证函数 `validateRubricJSON()` 和 Markdown 转换函数 `rubricToMarkdown()`。

---

### 19:40 - 后端 API 改造

**修改文件**: `/ai-grading-backend/src/app/api/ai/rubric/route.ts`

- 新增 `RUBRIC_JSON_PROMPT` 要求 AI 直接输出 JSON
- 配置 `response_format: { type: 'json_object' }` 强制 JSON 输出
- API 响应同时返回 `rubric`（Markdown）和 `rubricJSON`（结构化数据）

---

### 19:50 - 评分 Prompt 升级

**修改文件**: 
- `/ai-grading-backend/src/lib/gpt.ts`
- `/ai-grading-backend/src/lib/zhipu.ts`

`buildGradingPrompt()` 函数现在会检测输入是否为 JSON 格式：
- JSON 模式：逐点检查 `answerPoints`，根据 `keywords` 匹配
- Markdown 模式：保持原有逻辑（向后兼容）

---

### 20:00 - 前端类型同步

**修改文件**: `/ai-智能批改助手/types.ts`

新增类型定义：
- `RubricJSON`
- `AnswerPoint`
- `ScoringStrategy`
- `RubricResult`

---

### 20:10 - 前端服务层改造

**修改文件**: `/ai-智能批改助手/services/proxyService.ts`

- 新增 `lastGeneratedRubricJSON` 全局缓存
- 新增 `setImportedRubricJSON()` 函数支持手动导入
- `gradeWithProxy()` 优先使用 JSON 格式评分细则

---

### 20:20 - JSON 导入功能

**修改文件**: `/ai-智能批改助手/components/UnifiedRubricEditor.tsx`

增强 `handleImport()` 函数：
- 检测 `answerPoints` 字段识别 RubricJSON 格式
- 自动调用 `setImportedRubricJSON()` 存储用于评分
- 转换为 Markdown 用于预览显示

新增 `rubricJSONToMarkdown()` 函数实现 JSON → Markdown 转换。

---

### 20:25 - 示例文件创建

**新增文件**: `/ai-智能批改助手/18-2.json`

创建标准 RubricJSON 格式示例，包含：
- 5 个得分点
- 每点包含 `keywords` 关键词数组
- `pick_n` 评分策略（任选3点得满分）

---

### 20:30 - 预览格式修复

**问题**: JSON 导入后预览显示为 `gradingNotes` 而非 `answerPoints`

**原因**: 生成的 Markdown 小题标题缺少 `(序号)` 前缀

**修复**: `rubricJSONToMarkdown()` 中添加序号提取逻辑：
```typescript
const parts = (json.questionId || '1').split('-');
const subQuestionNo = parts[parts.length - 1];
// 格式: ### (2) 影响分析（6分）
```

---

### 20:35 - 评分详情增强

**修改文件**: `/ai-grading-backend/src/lib/gpt.ts`

升级 breakdown 输出要求：
- `label`: 得分点编号 + 参考答案内容
- `comment`: 详细评分理由
  - 得分时：✓ + 学生原文引用 + 匹配关键词
  - 扣分时：✗ + 具体缺失内容说明

---

### 20:40 - 辅助模式按钮修复

**修改文件**: `/ai-智能批改助手/components/GradingView.tsx`

**问题**: 辅助模式等待确认时只有「继续下一份」按钮，无法停止

**修复**: 同时显示两个按钮：
- 灰色「停止」按钮 → 调用 `stopAssist()`
- 蓝紫渐变「继续下一份」按钮 → 调用 `handleNextAssist()`

---

### 20:45 - PM2 持久化配置

**新增文件**: `/ai-grading-backend/ecosystem.config.js`

```javascript
module.exports = {
  apps: [{
    name: 'grading-backend',
    script: 'npm',
    args: 'start',
    autorestart: true,
    max_memory_restart: '500M'
  }]
};
```

**安装 PM2**: `npm install pm2 --save-dev`

---

## 变更文件汇总

| 文件路径 | 操作 | 说明 |
|----------|------|------|
| `ai-grading-backend/src/lib/rubric-types.ts` | 新增 | RubricJSON 类型定义 |
| `ai-grading-backend/src/app/api/ai/rubric/route.ts` | 修改 | AI 输出 JSON 格式 |
| `ai-grading-backend/src/lib/gpt.ts` | 修改 | JSON 评分 Prompt |
| `ai-grading-backend/src/lib/zhipu.ts` | 修改 | JSON 评分 Prompt |
| `ai-grading-backend/ecosystem.config.js` | 新增 | PM2 配置 |
| `ai-智能批改助手/types.ts` | 修改 | 类型定义 |
| `ai-智能批改助手/services/proxyService.ts` | 修改 | JSON 缓存支持 |
| `ai-智能批改助手/components/UnifiedRubricEditor.tsx` | 修改 | JSON 导入功能 |
| `ai-智能批改助手/components/GradingView.tsx` | 修改 | 辅助模式按钮 |
| `ai-智能批改助手/18-2.json` | 新增 | 示例评分细则 |

---

## 待办事项

- [ ] 启动 PM2 生产服务
- [ ] 前端可视化 JSON 编辑器
- [ ] 关键词管理界面
- [ ] 评分结果可视化（显示每点匹配情况）
