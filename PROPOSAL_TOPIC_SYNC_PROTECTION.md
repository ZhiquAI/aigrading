# 技术方案：题目同步与防错校验优化 (Topic Sync Protection)

## 1. 问题背景 (Context)
在实际阅卷场景（尤其是**盲评模式**）下，存在以下两个核心痛点：
*   **检测失效**：由于网页 URL 简化或 DOM 结构动态变化，侧边栏无法 100% 稳定地抓取到准确的题号。
*   **操作遗忘**：老师在连续批改不同题目时，极易忘记在插件中同步切换评分细则，导致 AI 拿着错误的题目标准去判分，产生大面积误判。

## 2. 核心目标 (Goals)
*   **内容级防错**：通过 AI 自动识别试卷内容，判断是否与当前选定的评分细则匹配。
*   **强制熔断**：当发现内容不匹配时，立即停止打分并显著提醒用户。
*   **无感同步**：在数据统计时，以“识别出的题号”为准，而非单纯依赖“选中的题号”。

## 3. 详细设计 (Detailed Design)

### 3.1 数据结构升级
在评分细则 (`Rubric`) 的数据模型中增加 `anchorKeywords` 字段：
```typescript
interface Rubric {
  questionNo: string;
  maxScore: number;
  content: string; // Markdown 细则
  // --- 新增 ---
  anchorKeywords: string[]; // 特征校验词，如 ["蒸汽机", "瓦特", "工厂"]
}
```

### 3.2 AI 逻辑优化 (Prompt 增强)
修改 AI 批改的 System Prompt，增加“预校验”指令：
> "你现在拥有【安全校验】权限。在评分前，请先核实图片内容：
> 1. 检查文字中是否包含以下特征词：${anchorKeywords}。
> 2. 如果图片内容与特征词完全无关（例如当前规则是关于工业革命，但图片内容是关于秦始皇），请立即停止。
> 3. 停止时返回格式：`{ "error": "TOPIC_MISMATCH", "detectedContext": "识别到的内容摘要" }`"

### 3.3 交互逻辑流程
1.  **配置阶段**：老师在创建/编辑评分细则时，输入 2-3 个该题特有的关键词。
2.  **批改阶段**：
    *   AI 识别图片 -> 命中关键词 -> 正常返回分数。
    *   AI 识别图片 -> 未命中关键词 -> 侧边栏 UI 变红，显示警告：“⚠️ 题目可能不匹配！当前规则是第15题，但内容疑似为XX，是否切换？”
3.  **智能建议**：如果系统中已配置过匹配该内容的细则（如第16题），提供“一键切换到第16题”的快捷按钮。

## 4. 实施路径 (Implementation)

- [ ] **Step 1: UI 改造**
  - 在 `UnifiedRubricEditor` 组件中增加关键词输入框。
- [ ] **Step 2: 后端/Store 适配**
  - 更新 `DeviceRubric` 数据库模型（Prisma）。
  - 更新 Zustand Store 的保存逻辑。
- [ ] **Step 3: Prompt 升级**
  - 在 `background.js` 的 `GRADE_ANSWER` 处理逻辑中动态注入关键词。
- [ ] **Step 4: 错误处理**
  - 在 `GradingView` 中增加对 `TOPIC_MISMATCH` 错误码的捕获和弹窗展示。

## 5. 预期效果
*   **零误判**：彻底杜绝“牛头不对马嘴”的错阅发生。
*   **统计精准**：每一条阅卷记录都会附带 AI 识别出的“真实题号”，确保统计图表真实可靠。
