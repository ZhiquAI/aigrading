# V3 全量替换实施任务单（剔除 V2）

## 0. 执行原则
1. 目标：前后端仅保留 `RubricJSONV3`，移除所有 V2 结构与兼容逻辑。
2. 策略：一次性全量迁移，不走长期双栈。
3. 范围：仅改 `aigradingfrontend` 与 `aigradingbackend`，不改 `personal`。

## 1. 提交任务（按顺序执行）

### T1 协议收敛（后端）
1. 任务：后端 API 完全只收发 V3，删除 V2 入口和 fallback。
2. 文件：`aigradingbackend/src/app/api/rubric/route.ts`、`aigradingbackend/src/app/api/ai/rubric/route.ts`、`aigradingbackend/src/app/api/ai/grade/route.ts`、`aigradingbackend/src/lib/rubric-types.ts`。
3. 验收：请求体中传 V2 返回明确错误码 `RUBRIC_SCHEMA_INVALID`。
4. 建议提交信息：`feat(backend): enforce rubric v3 only and remove v2 fallback`

### T2 协议收敛（前端）
1. 任务：前端状态、服务、页面只使用 V3 类型。
2. 文件：`aigradingfrontend/stores/useAppStore.ts`、`aigradingfrontend/services/rubric-service.ts`、`aigradingfrontend/services/proxyService.ts`、`aigradingfrontend/types.ts`。
3. 验收：前端代码中不再出现 V2 字段分支（`answerPoints` 兼容逻辑移除）。
4. 建议提交信息：`feat(frontend): use rubric v3 as single source of truth`

### T3 评分细则工作台重构
1. 任务：将评分细则入口统一为 V3 工作台，三策略编辑器为唯一编辑方式。
2. 文件：`aigradingfrontend/src/components/v2/views/RubricView.tsx`、`aigradingfrontend/src/components/v2/views/RubricCreateModal.tsx`、`aigradingfrontend/src/components/v2/views/rubric-editors/*`。
3. 验收：可在同一工作台完成创建、编辑、保存、模板应用。
4. 建议提交信息：`feat(frontend): unify rubric workspace on v3 editors`

### T4 模板库与推荐闭环
1. 任务：模板列表、模板保存、模板应用、模板删除、模板推荐全链路固定 V3。
2. 文件：`aigradingfrontend/services/rubric-templates.ts`、`aigradingbackend/src/app/api/rubric/templates/route.ts`、`aigradingbackend/src/app/api/ai/rubric/recommend/route.ts`。
3. 验收：推荐模板可一键应用到编辑器并直接保存为实例。
4. 建议提交信息：`feat(rubric): complete v3 template and recommendation workflow`

### T5 自动阅卷联动（低置信度暂停）
1. 任务：`needsReview/confidence` 驱动自动模式暂停，人工确认后继续。
2. 文件：`aigradingfrontend/src/components/v2/views/GradingViewV2.tsx`、`aigradingbackend/src/lib/score-engine.ts`、`aigradingbackend/src/lib/rubric-judge.ts`。
3. 验收：`needsReview=true` 时不自动提交下一份。
4. 建议提交信息：`feat(grading): pause auto flow on low confidence in v3 pipeline`

### T6 一次性迁移脚本
1. 任务：提供全量迁移脚本，把历史 V2 评分细则转为 V3 并回写。
2. 文件：`aigradingbackend/scripts/migrate-rubric-v2-to-v3.ts`（新增）、必要时补充 `package.json` 脚本。
3. 验收：脚本输出迁移统计，迁移后 `version != 3.0` 数量为 0。
4. 建议提交信息：`feat(migration): add one-shot rubric v2 to v3 migration script`

### T7 删除 V2 死代码
1. 任务：清理 V2 类型、转换器、旧 UI 编辑器和兼容分支。
2. 文件：全局检索并删除与 V2 专用相关文件与引用。
3. 验收：全仓检索无 V2 关键路径引用。
4. 建议提交信息：`refactor: remove legacy v2 rubric code paths`

### T8 文档与验收
1. 任务：更新设计与实现文档，完成验收报告。
2. 文件：`AI评分细则模块重构/*.md`、`scripts/check-frontend-rubric-v3.sh` 产出报告。
3. 验收：文档与代码一致，验收清单项全部通过。
4. 建议提交信息：`docs: finalize v3 rubric architecture and acceptance report`

## 2. 统一验收标准
1. 前端 `npm run build` 通过。
2. 后端类型检查与关键 API 冒烟通过。
3. E2E 8 个场景通过：三策略编辑、模板 CRUD、推荐应用、低置信度暂停。
4. 生产数据库抽样数据均为 `version: 3.0`。

## 3. 发布与回滚
1. 发布顺序：迁移脚本先执行，再发布后端，再发布前端。
2. 回滚策略：保留发布前数据库快照，回滚仅针对服务版本，不回滚已迁移数据。
